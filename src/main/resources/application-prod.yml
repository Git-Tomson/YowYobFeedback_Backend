# ============================================
# CONFIGURATION SERVEUR
# ============================================
server:
  port: ${PORT:8080}
  # ğŸ¯ RÃ´le: Port d'Ã©coute de l'application
  # ğŸ“– Explication:
  #    - ${PORT:8080} signifie: "Lire la variable d'environnement PORT, sinon utiliser 8080"
  #    - Koyeb injecte automatiquement PORT=8080
  #    - Pourquoi variable ? Permet Ã  Koyeb de changer le port si nÃ©cessaire
  # âŒ Si mal configurÃ©: L'app dÃ©marre mais Koyeb ne peut pas router le trafic
  forward-headers-strategy: framework
  #Spring ne regarde pas sa connexion mais les headers envoyÃ© par le proxy(load balancer) de koyeb
  #Le proxy de Koyeb envoie des headers comme X-Forwarded-Proto: https
  #Spring lit ce header et comprend que, pour l'utilisateur final,
  #il doit se comporter comme s'il Ã©tait en HTTPS.

# ============================================
# CONFIGURATION SPRING
# ============================================
spring:
  application:
    name: yowyob-feedback-api
    # ğŸ¯ RÃ´le: Identifiant de votre application dans les logs et mÃ©triques
    # ğŸ“– Explication: Utile quand vous avez plusieurs microservices
  
  # ------------------------------------------
  # R2DBC (Reactive Database Connectivity)
  # ------------------------------------------
  r2dbc:
    url: r2dbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}?sslmode=${DB_SSL_MODE:require}
    # ğŸ¯ RÃ´le: URL de connexion Ã  la base de donnÃ©es RÃ‰ACTIVE
    # ğŸ“– DÃ©cryptage de l'URL:
    #    â”Œâ”€ r2dbc:postgresql://  â†’ Protocole R2DBC pour PostgreSQL
    #    â”œâ”€ ${DB_HOST}           â†’ yowyob-feedback-db (hostname interne Koyeb)
    #    â”œâ”€ ${DB_PORT}           â†’ 5432 (port PostgreSQL)
    #    â”œâ”€ ${DB_NAME}           â†’ feedback_db
    #    â””â”€ ?sslmode=require     â†’ Force le chiffrement SSL
    # âŒ Sans SSL: Connexion refusÃ©e par Koyeb PostgreSQL
    # âŒ Sans variables: L'app essaie de se connecter Ã  localhost
    
    username: ${DB_USER}
    # ğŸ¯ RÃ´le: Nom d'utilisateur PostgreSQL
    # ğŸ“– Valeur: postgres (dÃ©fini Ã  l'Ã‰tape 1)
    
    password: ${DB_PASSWORD}
    # ğŸ¯ RÃ´le: Mot de passe PostgreSQL
    # ğŸ“– Valeur: Le mot de passe auto-gÃ©nÃ©rÃ© Ã  l'Ã‰tape 1
    # ğŸ”’ SÃ©curitÃ©: JAMAIS en dur ! Toujours via variable d'environnement
    
    pool:
      initial-size: 5
      # ğŸ¯ RÃ´le: Nombre de connexions crÃ©Ã©es au dÃ©marrage
      # ğŸ“– Explication: 5 connexions prÃªtes immÃ©diatement
      # ğŸ’¡ Impact performance: DÃ©marrage lÃ©gÃ¨rement plus lent, mais requÃªtes plus rapides aprÃ¨s
      
      max-size: 20
      # ğŸ¯ RÃ´le: Nombre maximum de connexions simultanÃ©es
      # ğŸ“– Explication: 
      #    - Limite de protection (Ã©vite de surcharger la DB)
      #    - 20 = bon Ã©quilibre pour instance Koyeb Nano/Free
      # âš ï¸ Si trop bas: RequÃªtes en attente si trafic Ã©levÃ©
      # âš ï¸ Si trop haut: Consommation excessive de RAM
      
      max-idle-time: 30m
      # ğŸ¯ RÃ´le: Temps avant de fermer une connexion inactive
      # ğŸ“– Explication: LibÃ¨re les ressources si peu de trafic
      # ğŸ’¡ 30 minutes = bon Ã©quilibre
      
      validation-query: SELECT 1
      # ğŸ¯ RÃ´le: RequÃªte pour vÃ©rifier qu'une connexion est encore valide
      # ğŸ“– Explication: Avant de rÃ©utiliser une connexion, R2DBC teste avec "SELECT 1"
      # â“ Pourquoi ? Ã‰vite d'utiliser une connexion fermÃ©e/corrompue
  
  # ------------------------------------------
  # LIQUIBASE (Migration de base de donnÃ©es)
  # ------------------------------------------
  liquibase:
    enabled: true
    # ğŸ¯ RÃ´le: Active Liquibase au dÃ©marrage de l'application
    # ğŸ“– Explication: Liquibase va crÃ©er/mettre Ã  jour vos tables automatiquement
    # âŒ Si disabled: Vos tables n'existent pas, l'app plante
    
    change-log: classpath:db/changelog/db.changelog-master.yaml
    # ğŸ¯ RÃ´le: Fichier principal Liquibase qui rÃ©fÃ©rence tous les changelogs
    # ğŸ“– Chemin: src/main/resources/db/changelog/db.changelog-master.yaml
    # ğŸ“ Structure:
    #    db.changelog-master.yaml
    #    â”œâ”€ include: changelog-001-create-tables.yaml
    #    â”œâ”€ include: changelog-002-alter-table-project.yaml
    #    â”œâ”€ include: changelog-003-add-2fa-and-password-reset.yaml
    #    â””â”€ include: changelog-004-add-counters.yaml
    #       include: changelog-005-create-approval-table.yaml

    
    url: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}?sslmode=${DB_SSL_MODE:require}
    # ğŸ¯ RÃ´le: URL de connexion JDBC (non rÃ©active) pour Liquibase
    # â“ Pourquoi JDBC et pas R2DBC ?
    #    - Liquibase ne supporte pas encore R2DBC nativement
    #    - JDBC est utilisÃ© UNIQUEMENT au dÃ©marrage pour les migrations
    #    - AprÃ¨s, toutes les requÃªtes utilisent R2DBC (rÃ©actif)
    # ğŸ“– jdbc:postgresql:// au lieu de r2dbc:postgresql://
    
    user: ${DB_USER}
    password: ${DB_PASSWORD}
    # ğŸ¯ RÃ´le: MÃªme credentials que R2DBC

# ============================================
# LOGGING
# ============================================
logging:
  level:
    root: INFO
    # ğŸ¯ RÃ´le: Niveau de log par dÃ©faut pour toutes les bibliothÃ¨ques
    # ğŸ“– INFO = Logs importants uniquement (pas de debug)
    # ğŸ’¡ En dev, vous utilisez DEBUG pour tout voir
    
    com.yowyob.feedback: DEBUG
    # ğŸ¯ RÃ´le: Niveau de log pour VOTRE code spÃ©cifiquement
    # ğŸ“– DEBUG = Voir tous les logs de vos services/controllers
    # ğŸ’¡ Utile pour dÃ©boguer en production
    
    org.springframework.r2dbc: DEBUG
    # ğŸ¯ RÃ´le: Voir les requÃªtes SQL exÃ©cutÃ©es par R2DBC
    # ğŸ“– Affiche: SELECT, INSERT, UPDATE avec les paramÃ¨tres
    # ğŸ’¡ TrÃ¨s utile pour diagnostiquer les problÃ¨mes de base de donnÃ©es
    # âš ï¸ En production intensive, passer Ã  INFO pour rÃ©duire les logs
  
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    # ğŸ¯ RÃ´le: Format d'affichage des logs
    # ğŸ“– Exemple de sortie:
    #    2026-01-25 14:32:05 - User registered successfully
    # ğŸ’¡ Simple et lisible dans les logs Koyeb

# ============================================
# ACTUATOR (Monitoring Spring Boot)
# ============================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
        # ğŸ¯ RÃ´le: Endpoints exposÃ©s pour monitorer l'application
        # ğŸ“– Endpoints disponibles:
        #    - /actuator/health   â†’ Ã‰tat de l'app (UP/DOWN)
        #    - /actuator/info     â†’ Infos sur l'app (version, etc.)
        #    - /actuator/metrics  â†’ MÃ©triques (CPU, RAM, requÃªtes, etc.)
        # âŒ Sans cela: Koyeb ne peut pas vÃ©rifier si l'app est en bonne santÃ©
  
  endpoint:
    health:
      show-details: always
      # ğŸ¯ RÃ´le: Affiche les dÃ©tails de santÃ© (DB, disk, etc.)
      # ğŸ“– Exemple de rÃ©ponse /actuator/health:
      #    {
      #      "status": "UP",
      #      "components": {
      #        "db": { "status": "UP", "details": {...} },
      #        "diskSpace": { "status": "UP" }
      #      }
      #    }
      # ğŸ’¡ TrÃ¨s utile pour diagnostiquer un problÃ¨me (DB down, disque plein, etc.)

# ============================================
# JWT (SÃ©curitÃ©)
# ============================================
jwt:
  secret: ${JWT_SECRET_KEY}
  # ğŸ¯ RÃ´le: ClÃ© secrÃ¨te pour signer les tokens JWT
  # ğŸ“– Explication: 
  #    - UtilisÃ© dans votre JwtService pour gÃ©nÃ©rer/valider les tokens
  #    - DOIT Ãªtre au moins 256 bits (32 caractÃ¨res)
  # ğŸ”’ SÃ©curitÃ©: JAMAIS en dur ! Variable d'environnement obligatoire
  # âŒ Si compromis: Un attaquant peut crÃ©er de faux tokens
  
  expiration: ${JWT_EXPIRATION:3600000}
  # ğŸ¯ RÃ´le: DurÃ©e de validitÃ© d'un token en millisecondes
  # ğŸ“– 3600000 ms = 1 heure
  # ğŸ’¡ AprÃ¨s 1h, l'utilisateur doit se reconnecter
  # âš–ï¸ Balance sÃ©curitÃ©/UX:
  #    - Court (15min) = Plus sÃ©curisÃ© mais moins pratique
  #    - Long (7 jours) = Plus pratique mais moins sÃ©curisÃ©
cors:
  allowed-origins: "*"
